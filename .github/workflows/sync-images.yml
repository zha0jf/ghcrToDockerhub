name: Sync GHCR to DockerHub

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'source_images/*'

jobs:
  push_multiarch_images:
    name: Sync amd64/arm64 images
    runs-on: ubuntu-latest
    permissions:
      contents: write # ÂÖÅËÆ∏Êèê‰∫§Áä∂ÊÄÅÊñá‰ª∂

    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USENAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Sync Images (amd64 & arm64)
        shell: bash
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        run: |
          # === ÈÖçÁΩÆÂå∫Âüü ===
          SOURCE_DIR="source_images"
          STATE_DIR="pushed_state"
          PLATFORMS="linux/amd64,linux/arm64"
          # ËÆæÁΩÆ‰ªìÂ∫ìÂêçÂâçÁºÄÔºåÁî®Êù•Ê®°Êãü "ghcr/" ÁõÆÂΩï
          REPO_PREFIX="ghcr-" 
          # ================

          mkdir -p $STATE_DIR

          for file in $SOURCE_DIR/*; do
              [ -e "$file" ] || continue

              # Ëé∑ÂèñÊ∫êÊñá‰ª∂Âêç‰Ωú‰∏∫Âü∫Á°ÄÂêçÁß∞ (‰æãÂ¶Ç: nginx)
              base_name=$(basename "$file")
              
              # ËØªÂèñÊ∫êÈïúÂÉèÂú∞ÂùÄ
              source_image=$(head -n 1 "$file" | tr -d '[:space:]')
              image_tag=$(echo $source_image | awk -F ':' '{print $2}')
              if [ -z "$image_tag" ]; then image_tag="latest"; fi

              # Ê£ÄÊü•Áä∂ÊÄÅ
              state_file="$STATE_DIR/$base_name"
              last_pushed_tag=""
              if [[ -f "$state_file" ]]; then
                  last_pushed_tag=$(cat "$state_file")
              fi

              if [[ "$image_tag" != "$last_pushed_tag" ]]; then
                  # ÁõÆÊ†áÁªìÊûÑ: username/ghcr-nginx:tag
                  target_repo="${REPO_PREFIX}${base_name}"
                  target_image="docker.io/${DOCKER_USER}/${target_repo}:${image_tag}"
                  
                  echo "üöÄ Syncing: $source_image -> $target_image"
                  
                  if docker buildx imagetools create \
                      --tag "$target_image" \
                      --platform "$PLATFORMS" \
                      "$source_image"; then
                      
                      echo "‚úÖ Success: $target_image"
                      echo "$image_tag" > "$state_file"
                  else
                      echo "‚ùå Failed."
                      exit 1
                  fi
              else
                  echo "‚è≠Ô∏è  Skipping $base_name (Tag $image_tag already synced)."
              fi
          done

      - name: Commit state changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update synced image states [skip ci]"
          file_pattern: 'pushed_state/*'
