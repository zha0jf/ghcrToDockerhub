name: Sync GHCR to DockerHub

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'source_images/*'        # å½“æºæ˜ åƒåˆ—è¡¨æ–‡ä»¶ä¿®æ”¹æ—¶è§¦å‘
      - '.github/workflows/**'   # å½“ Workflow è„šæœ¬ä¿®æ”¹æ—¶è§¦å‘

jobs:
  push_multiarch_images:
    name: Sync amd64/arm64 images
    runs-on: ubuntu-latest
    permissions:
      contents: write # å…è®¸æäº¤çŠ¶æ€æ–‡ä»¶

    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ç™»å½•ç”¨äºæ¨é€é•œåƒ
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Sync Images & Update Info
        shell: bash
        env:
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          # === é…ç½®åŒºåŸŸ ===
          SOURCE_DIR="source_images"
          STATE_DIR="pushed_state"
          PLATFORMS="linux/amd64,linux/arm64"
          REPO_PREFIX="ghcr-" 
          # ================

          mkdir -p $STATE_DIR

          # -------------------------------------------------------
          # 1. è·å– Docker Hub API Token (ç”¨äºæ›´æ–° README)
          # -------------------------------------------------------
          echo "ğŸ”‘ 1. Getting Docker Hub JWT Token..."
          
          # ä½¿ç”¨ jq æ„å»ºå®‰å…¨çš„ JSONï¼Œé˜²æ­¢å¯†ç ä¸­ç‰¹æ®Šå­—ç¬¦å¯¼è‡´é”™è¯¯
          LOGIN_PAYLOAD=$(jq -n \
            --arg u "$DOCKER_USER" \
            --arg p "$DOCKER_PASSWORD" \
            '{username: $u, password: $p}')

          # è¯·æ±‚ç™»å½•ï¼Œåˆ†ç¦»çŠ¶æ€ç å’Œå“åº”ä½“
          LOGIN_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d "$LOGIN_PAYLOAD" \
            https://hub.docker.com/v2/users/login)

          LOGIN_HTTP_CODE=$(echo "$LOGIN_RESPONSE" | tail -n1)
          LOGIN_BODY=$(echo "$LOGIN_RESPONSE" | sed '$d')

          if [ "$LOGIN_HTTP_CODE" -eq 200 ]; then
              HUB_TOKEN=$(echo "$LOGIN_BODY" | jq -r .token)
              echo "âœ… API Token obtained successfully."
          else
              echo "âš ï¸  Failed to get API Token (HTTP $LOGIN_HTTP_CODE). Description update will be skipped."
              echo "Response: $LOGIN_BODY"
              HUB_TOKEN="null"
          fi

          # -------------------------------------------------------
          # å®šä¹‰æ›´æ–° Docker Hub è¯´æ˜çš„å‡½æ•°
          # -------------------------------------------------------
          update_hub_info() {
              local repo_name="$1"
              local source_img="$2"
              local original_tag="$3"
              local target_img="$4"
              
              # å‡†å¤‡çŸ­æè¿° (Description)
              local short_desc="Mirror of $source_img ($original_tag)"

              # === ä¿®æ­£ç‚¹ï¼šEOF ä¸ local ä¿æŒä¸¥æ ¼å¯¹é½ ===
              local readme_content=$(cat <<EOF | sed 's/^[ \t]*//'
              # GHCR Mirror: $repo_name

              This repository is a transparent mirror synchronized from GitHub Container Registry (GHCR).

              ## Image Info

              - **Source Image**: \`$source_img\`
              - **Original Tag**: \`$original_tag\`
              - **Mirror Image**: \`$target_img\`
              - **Architectures**: \`amd64\`, \`arm64\`
              - **Sync Time**: $(date -u) UTC

              ---
              *Powered by GitHub Actions*
              EOF
              )
              # ==========================================              

              # ä½¿ç”¨ jq æ„å»º JSONï¼Œç¡®ä¿ Markdown è½¬ä¹‰æ­£ç¡®
              local json_payload=$(jq -n \
                --arg short "$short_desc" \
                --arg full "$readme_content" \
                '{"description": $short, "full_description": $full}')

              echo "ğŸ“ Updating Info for $repo_name..."
              
              # å‘é€ PATCH è¯·æ±‚
              UPDATE_CODE=$(curl -s -o response.json -w "%{http_code}" -X PATCH \
                  -H "Authorization: JWT $HUB_TOKEN" \
                  -H "Content-Type: application/json" \
                  -d "$json_payload" \
                  "https://hub.docker.com/v2/repositories/${DOCKER_USER}/${repo_name}/")

              if [ "$UPDATE_CODE" -eq 200 ]; then
                  echo "âœ… Info updated successfully."
              else
                  echo "âŒ Failed to update info (HTTP $UPDATE_CODE)."
                  echo "ğŸ” Server Response:"
                  cat response.json
                  echo ""
              fi
          }

          # -------------------------------------------------------
          # 2. å¾ªç¯å¤„ç†é•œåƒ
          # -------------------------------------------------------
          for file in $SOURCE_DIR/*; do
              [ -e "$file" ] || continue

              base_name=$(basename "$file")
              source_image=$(head -n 1 "$file" | tr -d '[:space:]')
              image_tag=$(echo $source_image | awk -F ':' '{print $2}')
              if [ -z "$image_tag" ]; then image_tag="latest"; fi

              state_file="$STATE_DIR/$base_name"
              last_pushed_tag=""
              if [[ -f "$state_file" ]]; then
                  last_pushed_tag=$(cat "$state_file")
              fi

              # æ£€æŸ¥ Tag æ˜¯å¦å˜æ›´
              if [[ "$image_tag" != "$last_pushed_tag" ]]; then
                  target_repo="${REPO_PREFIX}${base_name}"
                  target_image="docker.io/${DOCKER_USER}/${target_repo}:${image_tag}"
                  
                  echo "ğŸš€ Syncing: $source_image -> $target_image"
                  
                  # åŠ¨æ€ç”Ÿæˆ Dockerfile
                  echo "FROM $source_image" > Dockerfile
                  
                  # ä½¿ç”¨ buildx build å¼ºåˆ¶æ‹‰å–å¹¶é‡æ–°æ¨é€ (è§£å†³ 400 Bad Request é—®é¢˜)
                  if docker buildx build \
                      --platform "$PLATFORMS" \
                      --tag "$target_image" \
                      --provenance=false \
                      --push \
                      . ; then
                      
                      echo "âœ… Push Success: $target_image"
                      echo "$image_tag" > "$state_file"

                      # å¦‚æœè·å–åˆ°äº† Tokenï¼Œåˆ™æ›´æ–°è¯´æ˜
                      if [ "$HUB_TOKEN" != "null" ]; then
                          update_hub_info "$target_repo" "$source_image" "$image_tag" "$target_image"
                      fi
                  else
                      echo "âŒ Failed to sync $base_name"
                      rm -f Dockerfile
                      exit 1
                  fi
                  
                  rm -f Dockerfile
              else
                  echo "â­ï¸  Skipping $base_name (Tag $image_tag already synced)."
              fi
          done

      - name: Commit state changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update synced image states [skip ci]"
          file_pattern: 'pushed_state/*'
