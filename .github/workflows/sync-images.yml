name: Sync GHCR to DockerHub

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'source_images/*'
      - '.github/workflows/**'   # <--- Êñ∞Â¢ûÔºöÂΩì Workflow Êú¨Ë∫´‰ª£Á†Å‰øÆÊîπÊó∂‰πüËß¶Âèë

jobs:
  push_multiarch_images:
    name: Sync amd64/arm64 images
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Sync Images & Update README
        shell: bash
        env:
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          # Ê≥®ÊÑèÔºöAPI Ë∞ÉÁî®ÈúÄË¶ÅÂØÜÁ†ÅÊàñ TokenÔºåËøôÈáåÁõ¥Êé•Â§çÁî® Token
          DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          SOURCE_DIR="source_images"
          STATE_DIR="pushed_state"
          PLATFORMS="linux/amd64,linux/arm64"
          REPO_PREFIX="ghcr-" 

          mkdir -p $STATE_DIR

          # 1. Ëé∑Âèñ Docker Hub API Token (Áî®‰∫éÊõ¥Êñ∞ README)
          # Ê≥®ÊÑèÔºöAccess Token ÂøÖÈ°ªÂÖ∑Êúâ Read & Write ÊùÉÈôê
          echo "üîë Authenticating with Docker Hub API..."
          HUB_TOKEN=$(curl -s -H "Content-Type: application/json" -X POST -d "{\"username\": \"$DOCKER_USER\", \"password\": \"$DOCKER_PASSWORD\"}" https://hub.docker.com/v2/users/login | jq -r .token)
          
          if [ "$HUB_TOKEN" == "null" ]; then
            echo "‚ö†Ô∏è  Failed to get Docker Hub API Token. README update will be skipped."
          fi

          # ÂÆö‰πâÊõ¥Êñ∞ README ÁöÑÂáΩÊï∞
          update_readme() {
              local repo_name="$1"
              local source_img="$2"
              local original_tag="$3"
              local target_img="$4"
              
              # ÁîüÊàê Markdown ÂÜÖÂÆπ
              local readme_content="# GHCR Mirror: $repo_name
              
              This repository is a transparent mirror synchronized from GitHub Container Registry (GHCR).
              
              ## Image Info
              
              - **Source Image**: \`$source_img\`
              - **Original Tag**: \`$original_tag\`
              - **Mirror Image**: \`$target_img\`
              - **Architectures**: \`amd64\`, \`arm64\`
              - **Sync Time**: $(date -u) UTC
              
              ---
              *Powered by GitHub Actions*"

              # ‰ΩøÁî® jq ÊûÑÂª∫ JSON payload (Â§ÑÁêÜÊç¢Ë°åÂíåËΩ¨‰πâ)
              local json_payload=$(jq -n --arg desc "$readme_content" '{"full_description": $desc}')

              # Ë∞ÉÁî® API Êõ¥Êñ∞
              echo "üìù Updating README for $repo_name..."
              curl -s -o /dev/null -X PATCH \
                  -H "Authorization: JWT $HUB_TOKEN" \
                  -H "Content-Type: application/json" \
                  -d "$json_payload" \
                  "https://hub.docker.com/v2/repositories/${DOCKER_USER}/${repo_name}/"
          }

          # 2. ÂºÄÂßãÂæ™ÁéØÂ§ÑÁêÜ
          for file in $SOURCE_DIR/*; do
              [ -e "$file" ] || continue

              base_name=$(basename "$file")
              source_image=$(head -n 1 "$file" | tr -d '[:space:]')
              image_tag=$(echo $source_image | awk -F ':' '{print $2}')
              if [ -z "$image_tag" ]; then image_tag="latest"; fi

              state_file="$STATE_DIR/$base_name"
              last_pushed_tag=""
              if [[ -f "$state_file" ]]; then
                  last_pushed_tag=$(cat "$state_file")
              fi

              if [[ "$image_tag" != "$last_pushed_tag" ]]; then
                  target_repo="${REPO_PREFIX}${base_name}"
                  target_image="docker.io/${DOCKER_USER}/${target_repo}:${image_tag}"
                  
                  echo "üöÄ Syncing: $source_image -> $target_image"
                  
                  echo "FROM $source_image" > Dockerfile
                  
                  if docker buildx build \
                      --platform "$PLATFORMS" \
                      --tag "$target_image" \
                      --provenance=false \
                      --push \
                      . ; then
                      
                      echo "‚úÖ Success: $target_image"
                      echo "$image_tag" > "$state_file"

                      # === 3. Ë∞ÉÁî®ÂáΩÊï∞Êõ¥Êñ∞ README ===
                      if [ "$HUB_TOKEN" != "null" ]; then
                          update_readme "$target_repo" "$source_image" "$image_tag" "$target_image"
                      fi
                  else
                      echo "‚ùå Failed to sync $base_name"
                      rm -f Dockerfile
                      exit 1
                  fi
                  
                  rm -f Dockerfile
              else
                  echo "‚è≠Ô∏è  Skipping $base_name (Tag $image_tag already synced)."
              fi
          done

      - name: Commit state changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update synced image states [skip ci]"
          file_pattern: 'pushed_state/*'
