name: Sync GHCR to DockerHub

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'source_images/*'
      - '.github/workflows/**'

jobs:
  push_multiarch_images:
    name: Sync amd64/arm64 images
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Sync Images & Update Info
        shell: bash
        env:
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          SOURCE_DIR="source_images"
          STATE_DIR="pushed_state"
          PLATFORMS="linux/amd64,linux/arm64"
          REPO_PREFIX="ghcr-" 

          mkdir -p $STATE_DIR

          echo "üîë Authenticating with Docker Hub API..."
          HUB_TOKEN=$(curl -s -H "Content-Type: application/json" -X POST -d "{\"username\": \"$DOCKER_USER\", \"password\": \"$DOCKER_PASSWORD\"}" https://hub.docker.com/v2/users/login | jq -r .token)
          
          if [ "$HUB_TOKEN" == "null" ] || [ -z "$HUB_TOKEN" ]; then
            echo "‚ö†Ô∏è  Failed to get Docker Hub API Token. Description update will be skipped."
            HUB_TOKEN="null"
          fi

          update_hub_info() {
              local repo_name="$1"
              local source_img="$2"
              local original_tag="$3"
              local target_img="$4"
              
              # 1. ÂáÜÂ§á Short Description (ÁΩëÈ°µÊ†áÈ¢ò‰∏ãÊñπÁöÑÁü≠ÊèèËø∞)
              local short_desc="Mirror of $source_img ($original_tag)"

              # 2. ÂáÜÂ§á Overview (ÈïøÁØá README Markdown)
              local readme_content="# GHCR Mirror: $repo_name
              
              This repository is a transparent mirror synchronized from GitHub Container Registry (GHCR).
              
              ## Image Info
              
              - **Source Image**: \`$source_img\`
              - **Original Tag**: \`$original_tag\`
              - **Mirror Image**: \`$target_img\`
              - **Architectures**: \`amd64\`, \`arm64\`
              - **Sync Time**: $(date -u) UTC
              
              ---
              *Powered by GitHub Actions*"

              # 3. ÊûÑÂª∫ JSON (ÂêåÊó∂ÂåÖÂê´ description Âíå full_description)
              local json_payload=$(jq -n \
                --arg short "$short_desc" \
                --arg full "$readme_content" \
                '{"description": $short, "full_description": $full}')

              echo "üìù Updating Docker Hub Info (Overview & Description) for $repo_name..."
              
              HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" -X PATCH \
                  -H "Authorization: JWT $HUB_TOKEN" \
                  -H "Content-Type: application/json" \
                  -d "$json_payload" \
                  "https://hub.docker.com/v2/repositories/${DOCKER_USER}/${repo_name}/")

              if [ "$HTTP_CODE" -eq 200 ]; then
                  echo "‚úÖ Docker Hub info updated successfully."
              else
                  echo "‚ùå Failed to update info. HTTP Code: $HTTP_CODE"
                  echo "üîç Server Response:"
                  cat response.json
                  echo ""
              fi
          }

          for file in $SOURCE_DIR/*; do
              [ -e "$file" ] || continue

              base_name=$(basename "$file")
              source_image=$(head -n 1 "$file" | tr -d '[:space:]')
              image_tag=$(echo $source_image | awk -F ':' '{print $2}')
              if [ -z "$image_tag" ]; then image_tag="latest"; fi

              state_file="$STATE_DIR/$base_name"
              last_pushed_tag=""
              if [[ -f "$state_file" ]]; then
                  last_pushed_tag=$(cat "$state_file")
              fi

              if [[ "$image_tag" != "$last_pushed_tag" ]]; then
                  target_repo="${REPO_PREFIX}${base_name}"
                  target_image="docker.io/${DOCKER_USER}/${target_repo}:${image_tag}"
                  
                  echo "üöÄ Syncing: $source_image -> $target_image"
                  
                  echo "FROM $source_image" > Dockerfile
                  
                  if docker buildx build \
                      --platform "$PLATFORMS" \
                      --tag "$target_image" \
                      --provenance=false \
                      --push \
                      . ; then
                      
                      echo "‚úÖ Success: $target_image"
                      echo "$image_tag" > "$state_file"

                      if [ "$HUB_TOKEN" != "null" ]; then
                          update_hub_info "$target_repo" "$source_image" "$image_tag" "$target_image"
                      fi
                  else
                      echo "‚ùå Failed to sync $base_name"
                      rm -f Dockerfile
                      exit 1
                  fi
                  
                  rm -f Dockerfile
              else
                  echo "‚è≠Ô∏è  Skipping $base_name (Tag $image_tag already synced)."
              fi
          done

      - name: Commit state changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update synced image states [skip ci]"
          file_pattern: 'pushed_state/*'
